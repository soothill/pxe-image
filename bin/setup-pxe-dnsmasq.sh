#!/usr/bin/env bash
# setup-pxe-dnsmasq.sh
#
# Configure dnsmasq as a DHCP + PXE/TFTP server on eth1 for network 10.10.115.0/24.
#
# - DHCP range: 10.10.115.10 – 10.10.115.199
# - Router (gateway): 10.10.115.254
# - DNS server: 10.10.115.254
# - next-server (TFTP/PXE): 10.10.115.200
# - TFTP root: /srv/tftpboot
#
# Target OS: openSUSE Leap 15.6 (zypper + firewalld + dnsmasq)

set -euo pipefail

ETH_IFACE="eth1"
DHCP_RANGE_START="10.10.115.10"
DHCP_RANGE_END="10.10.115.199"
DHCP_NETMASK="255.255.255.0"
DHCP_LEASE_TIME="12h"
ROUTER_IP="10.10.115.254"
DNS_IP="10.10.115.254"
NEXT_SERVER_IP="10.10.115.200"
TFTP_ROOT="/srv/tftpboot"
DNSMASQ_MAIN_CONF="/etc/dnsmasq.conf"
DNSMASQ_D_DIR="/etc/dnsmasq.d"
DNSMASQ_PXE_CONF="${DNSMASQ_D_DIR}/pxe-dhcp.conf"

log() {
  echo "[INFO] $*"
}

warn() {
  echo "[WARN] $*" >&2
}

error() {
  echo "[ERROR] $*" >&2
  exit 1
}

require_root() {
  if [[ "${EUID:-$(id -u)}" -ne 0 ]]; then
    error "This script must be run as root. Try: sudo $0"
  fi
}

command_exists() {
  command -v "$1" >/dev/null 2>&1
}

check_interface() {
  if ! ip link show dev "${ETH_IFACE}" >/dev/null 2>&1; then
    error "Network interface ${ETH_IFACE} does not exist."
  fi
}

check_other_dhcp() {
  # Best-effort check for other common DHCP daemons. Only warn; do not abort.
  local services=(dhcpd isc-dhcp-server kea-dhcp4)
  local found=""
  for svc in "${services[@]}"; do
    if systemctl is-active --quiet "$svc" 2>/dev/null; then
      found+=" $svc"
    fi
  done
  if [[ -n "$found" ]]; then
    warn "Other active DHCP services detected:${found}. Ensure there is only one DHCP server on this network."
  fi
}

install_packages() {
  if ! command_exists zypper; then
    error "zypper not found. This script is intended for openSUSE Leap."
  fi

  log "Installing required packages (dnsmasq, syslinux) via zypper..."
  zypper -n install --no-confirm dnsmasq syslinux
}

configure_dnsmasq_confdir() {
  mkdir -p "${DNSMASQ_D_DIR}"

  if [[ ! -f "${DNSMASQ_MAIN_CONF}" ]]; then
    warn "${DNSMASQ_MAIN_CONF} not found; creating a minimal one."
    cat > "${DNSMASQ_MAIN_CONF}" <<EOF
# Minimal dnsmasq configuration created by setup-pxe-dnsmasq.sh
# Additional configuration files are loaded from ${DNSMASQ_D_DIR}
conf-dir=${DNSMASQ_D_DIR},*.conf
EOF
    return
  fi

  if ! grep -qE "^\s*conf-dir=.*${DNSMASQ_D_DIR}" "${DNSMASQ_MAIN_CONF}" 2>/dev/null; then
    log "Ensuring ${DNSMASQ_MAIN_CONF} loads configs from ${DNSMASQ_D_DIR}..."
    cp "${DNSMASQ_MAIN_CONF}" "${DNSMASQ_MAIN_CONF}.bak" 2>/dev/null || true
    echo "" >> "${DNSMASQ_MAIN_CONF}"
    echo "# Include additional dnsmasq configuration snippets" >> "${DNSMASQ_MAIN_CONF}"
    echo "conf-dir=${DNSMASQ_D_DIR},*.conf" >> "${DNSMASQ_MAIN_CONF}"
  fi
}

write_pxe_dnsmasq_config() {
  log "Writing PXE/DHCP configuration to ${DNSMASQ_PXE_CONF}..."

  if [[ -f "${DNSMASQ_PXE_CONF}" && ! -f "${DNSMASQ_PXE_CONF}.bak" ]]; then
    cp "${DNSMASQ_PXE_CONF}" "${DNSMASQ_PXE_CONF}.bak"
    log "Existing ${DNSMASQ_PXE_CONF} backed up to ${DNSMASQ_PXE_CONF}.bak"
  fi

  cat > "${DNSMASQ_PXE_CONF}" <<EOF
# PXE + DHCP configuration generated by setup-pxe-dnsmasq.sh

# Bind only to the specified interface
interface=${ETH_IFACE}
bind-interfaces

# DHCP range and lease time
# Range: ${DHCP_RANGE_START} – ${DHCP_RANGE_END}, netmask ${DHCP_NETMASK}
dhcp-range=${DHCP_RANGE_START},${DHCP_RANGE_END},${DHCP_NETMASK},${DHCP_LEASE_TIME}

# Router (option 3) and DNS (option 6)
dhcp-option=3,${ROUTER_IP}
dhcp-option=6,${DNS_IP}

# PXE boot configuration
# Serve pxelinux.0 from TFTP root, with next-server ${NEXT_SERVER_IP}
dhcp-boot=pxelinux.0,,${NEXT_SERVER_IP}

# Enable built-in TFTP server
enable-tftp
tftp-root=${TFTP_ROOT}

# Log DHCP transactions for troubleshooting
log-dhcp
EOF
}

setup_tftp_root() {
  log "Setting up TFTP root at ${TFTP_ROOT}..."
  mkdir -p "${TFTP_ROOT}"
  chmod 0755 "${TFTP_ROOT}"

  local candidates=(
    /usr/share/syslinux
    /usr/lib/syslinux
    /usr/lib64/syslinux
  )

  local src=""
  for d in "${candidates[@]}"; do
    if [[ -d "$d" ]]; then
      src="$d"
      break
    fi
  done

  if [[ -z "$src" ]]; then
    warn "Could not find syslinux PXE files (pxelinux.0, *.c32). You may need to copy them into ${TFTP_ROOT} manually."
  else
    log "Copying PXELINUX bootloader files from $src to ${TFTP_ROOT} (if present)..."
    for f in pxelinux.0 ldlinux.c32 menu.c32 libcom32.c32 libutil.c32; do
      if [[ -f "$src/$f" ]]; then
        cp -u "$src/$f" "${TFTP_ROOT}/" || true
      fi
    done
  fi

  # Create a basic pxelinux.cfg/default if none exists, as a template
  local cfg_dir="${TFTP_ROOT}/pxelinux.cfg"
  local cfg_file="${cfg_dir}/default"
  if [[ ! -f "$cfg_file" ]]; then
    log "Creating example PXE menu at ${cfg_file} (please customize for your image)..."
    mkdir -p "$cfg_dir"
    cat > "$cfg_file" <<'EOF'
DEFAULT menu.c32
PROMPT 0
TIMEOUT 50
ONTIMEOUT auto

MENU TITLE PXE Boot Menu

LABEL auto
  MENU LABEL Automated install
  KERNEL images/vmlinuz
  APPEND initrd=images/initrd.img ip=dhcp
EOF
  else
    log "Existing PXE config ${cfg_file} detected; leaving it unchanged."
  fi
}

configure_firewall() {
  if ! command_exists firewall-cmd; then
    warn "firewalld/firewall-cmd not found. Please ensure ports 67/UDP, 68/UDP and 69/UDP are open manually."
    return
  fi

  if ! systemctl is-active --quiet firewalld 2>/dev/null; then
    warn "firewalld is not active. Please ensure ports 67/UDP, 68/UDP and 69/UDP are open in your firewall."
    return
  fi

  log "Configuring firewalld to allow DHCP and TFTP..."
  # Try using predefined services if available
  firewall-cmd --add-service=dhcp --permanent || true
  firewall-cmd --add-service=tftp --permanent || true

  # Also ensure the specific ports are opened as a fallback
  firewall-cmd --add-port=67/udp --permanent || true
  firewall-cmd --add-port=69/udp --permanent || true

  firewall-cmd --reload || true
}

start_dnsmasq() {
  log "Enabling and starting dnsmasq service..."
  systemctl enable --now dnsmasq
  systemctl --no-pager --full status dnsmasq || true
}

main() {
  require_root
  check_interface
  check_other_dhcp
  install_packages
  configure_dnsmasq_confdir
  write_pxe_dnsmasq_config
  setup_tftp_root
  configure_firewall
  start_dnsmasq

  cat <<EOF

============================================================
PXE/DHCP setup complete.

- Interface:      ${ETH_IFACE}
- DHCP range:     ${DHCP_RANGE_START} – ${DHCP_RANGE_END} (${DHCP_NETMASK})
- Router (opt 3): ${ROUTER_IP}
- DNS (opt 6):    ${DNS_IP}
- next-server:    ${NEXT_SERVER_IP}
- TFTP root:      ${TFTP_ROOT}

Clients on the 10.10.115.0/24 network connected to ${ETH_IFACE}
should now receive DHCP leases and be directed to boot via PXE
from ${NEXT_SERVER_IP} (pxelinux.0).

Remember to copy your kernel and initrd into:
  ${TFTP_ROOT}/images/
and adjust:
  ${TFTP_ROOT}/pxelinux.cfg/default
accordingly.
============================================================
EOF
}

main "$@"
